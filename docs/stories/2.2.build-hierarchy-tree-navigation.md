# Story 2.2: Build Hierarchy Tree Navigation (Left Column)

**Status:** Approved

---

## Story

**As a** user,
**I want** to see my Initiatives and Epics in a tree structure,
**so that** I can navigate my project hierarchy easily.

---

## Acceptance Criteria

1. Tree component displays:
   - Initiative nodes (expandable)
   - Epic nodes nested under Initiatives (read-only in MVP, sourced from PRD)
2. Clicking Initiative navigates to Initiative overview
3. Clicking Epic navigates to Epic detail (shows related documents)
4. Active node highlighted with background color
5. Tree supports keyboard navigation (Arrow keys, Enter to select)

---

## Tasks / Subtasks

- [ ] **Task 1: Install shadcn/ui Sidebar Component** (AC: 1, 5)
  - [ ] Run `npx shadcn@latest add sidebar` to install sidebar component
  - [ ] Add required CSS variables for sidebar theming to `apps/web/app/globals.css`
  - [ ] Verify sidebar component files are created in `apps/web/components/ui/sidebar.tsx`
  - [ ] Verify TypeScript type definitions are available

- [ ] **Task 2: Create React Query Hooks for Data Fetching** (AC: 1)
  - [ ] Create `apps/web/lib/hooks/useInitiatives.ts` hook
  - [ ] Implement `useInitiatives()` using React Query to fetch all user initiatives
  - [ ] Create `apps/web/lib/hooks/useEpics.ts` hook
  - [ ] Implement `useEpics(initiativeId: string)` to fetch epics for an initiative
  - [ ] Configure proper query keys: `['initiatives']` and `['epics', initiativeId]`
  - [ ] Add loading, error, and success states handling
  - [ ] Mock API responses initially (API endpoints will be implemented in Epic 7)

- [ ] **Task 3: Update WorkspaceShell to Use SidebarProvider** (AC: 1)
  - [ ] Update `apps/web/components/workspace/WorkspaceShell.tsx` to wrap layout in `SidebarProvider`
  - [ ] Replace `react-resizable-panels` layout with shadcn Sidebar pattern
  - [ ] Use `Sidebar` component for left panel instead of Panel component
  - [ ] Use `SidebarInset` for middle and right content area
  - [ ] Maintain responsive behavior (desktop/tablet/mobile)
  - [ ] Update tests to accommodate new Sidebar structure

- [ ] **Task 4: Create AppSidebar Component with Hierarchy Navigation** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `apps/web/components/hierarchy/AppSidebar.tsx` as client component
  - [ ] Define TypeScript interfaces for navigation items (Initiative and Epic nodes)
  - [ ] Use `SidebarMenu` with `Collapsible` for expandable Initiative sections
  - [ ] Implement Initiative nodes using `SidebarMenuItem` and `SidebarMenuButton`
  - [ ] Implement Epic nodes using `SidebarMenuSub`, `SidebarMenuSubItem`, `SidebarMenuSubButton`
  - [ ] Add expand/collapse state management using Collapsible component
  - [ ] Add loading skeleton using `SidebarGroupContent` while initiatives/epics are fetching
  - [ ] Add error state display if data fetching fails

- [ ] **Task 5: Implement Navigation Functionality** (AC: 2, 3)
  - [ ] Use Next.js `Link` components in `SidebarMenuButton` with `asChild` prop
  - [ ] Initiative nodes navigate to `/dashboard/initiatives/[id]`
  - [ ] Epic nodes navigate to `/dashboard/initiatives/[initiativeId]/epics/[epicId]`
  - [ ] Ensure proper SEO and prefetching with Next.js Link
  - [ ] Prevent navigation when clicking Collapsible trigger (expand/collapse icon)

- [ ] **Task 6: Implement Active Node Highlighting** (AC: 4)
  - [ ] Use Next.js `usePathname()` hook to detect current route
  - [ ] Parse pathname to extract current initiativeId and epicId (if present)
  - [ ] Use `isActive` prop on `SidebarMenuButton` for active Initiative node
  - [ ] Use `isActive` prop on `SidebarMenuSubButton` for active Epic node
  - [ ] Auto-expand Collapsible if active Epic is nested under an Initiative
  - [ ] Apply `bg-sidebar-accent` and `text-sidebar-accent-foreground` for active states

- [ ] **Task 7: Implement Keyboard Navigation** (AC: 5)
  - [ ] Verify `SidebarMenuButton` supports keyboard navigation (built into shadcn component)
  - [ ] Test Tab key navigation through menu items
  - [ ] Test Enter/Space to activate menu items (navigate)
  - [ ] Test Arrow keys for expand/collapse on Collapsible triggers
  - [ ] Ensure focus indicators are visible (focus ring from shadcn components)
  - [ ] Test with keyboard-only navigation (no mouse)

- [ ] **Task 8: Add Sidebar Header and Footer** (AC: 1)
  - [ ] Add `SidebarHeader` with "Projects" label using `SidebarGroupLabel`
  - [ ] Add "Create Initiative" action button in header using `SidebarGroupAction`
  - [ ] Button should show Plus icon and be disabled for MVP (functionality in Epic 7)
  - [ ] Optionally add `SidebarFooter` for user profile or settings (deferred to later stories)
  - [ ] Style header and footer according to shadcn Sidebar theming

- [ ] **Task 9: Create Mock Data Service** (AC: 1)
  - [ ] Create `apps/web/lib/services/mock-data.ts` utility
  - [ ] Define mock Initiative data (2-3 sample initiatives)
  - [ ] Define mock Epic data structure (parse from PRD markdown headings format)
  - [ ] Export functions: `getMockInitiatives()`, `getMockEpics(initiativeId: string)`
  - [ ] Use in React Query hooks until real API endpoints are implemented
  - [ ] Document that this is temporary and will be replaced in Epic 7

- [ ] **Task 10: Write Unit Tests for AppSidebar Component** (AC: 1, 2, 3, 4, 5)
  - [ ] Create test file: `apps/web/components/hierarchy/__tests__/AppSidebar.test.tsx`
  - [ ] Test component renders Initiative nodes using SidebarMenu
  - [ ] Test Collapsible expand/collapse functionality for Initiative nodes
  - [ ] Test Epic nodes appear in SidebarMenuSub when Initiative is expanded
  - [ ] Test clicking Initiative node Link triggers navigation
  - [ ] Test clicking Epic node Link triggers navigation
  - [ ] Test `isActive` prop applied correctly based on current pathname
  - [ ] Test keyboard Tab navigation through menu items
  - [ ] Mock React Query hooks with MSW or vi.mock
  - [ ] Mock Next.js usePathname hook
  - [ ] Mock shadcn Sidebar components if needed

- [ ] **Task 11: Write Unit Tests for React Query Hooks** (AC: 1)
  - [ ] Create test file: `apps/web/lib/hooks/__tests__/useInitiatives.test.ts`
  - [ ] Test useInitiatives() returns loading state initially
  - [ ] Test useInitiatives() returns data on success
  - [ ] Test useInitiatives() returns error state on failure
  - [ ] Repeat tests for useEpics(initiativeId) hook
  - [ ] Use React Query testing utilities (@tanstack/react-query)
  - [ ] Mock mock-data service responses

- [ ] **Task 12: Write Integration Test for WorkspaceShell with Sidebar** (AC: 1, 2, 3, 4)
  - [ ] Update test file: `apps/web/components/workspace/__tests__/WorkspaceShell.test.tsx`
  - [ ] Test WorkspaceShell renders with SidebarProvider
  - [ ] Test Sidebar component is rendered
  - [ ] Test SidebarInset renders middle and right panels
  - [ ] Test "Create Initiative" button is present in SidebarHeader (even if disabled)
  - [ ] Test sidebar scrolling works with long initiative lists
  - [ ] Test SidebarTrigger toggle functionality
  - [ ] Use React Testing Library with React Query provider wrapper

- [ ] **Task 13: Verify Accessibility Features** (AC: 5)
  - [ ] Verify shadcn Sidebar components include proper ARIA attributes (built-in)
  - [ ] Verify Collapsible component includes aria-expanded (built-in)
  - [ ] Add aria-label to SidebarGroupAction ("Create new initiative")
  - [ ] Ensure screen reader announces node names and states correctly
  - [ ] Test with VoiceOver (macOS) or NVDA (Windows)
  - [ ] Verify focus indicators are visible and meet WCAG AA standards
  - [ ] Test keyboard navigation with screen reader enabled

- [ ] **Task 14: Run Build and Linting** (AC: 1-5)
  - [ ] Run `pnpm --filter @outcome-signal/web build` to verify production build succeeds
  - [ ] Run `pnpm --filter @outcome-signal/web lint` to check for linting issues
  - [ ] Run `pnpm --filter @outcome-signal/web test -- --run` to verify all tests pass
  - [ ] Fix any TypeScript errors or warnings
  - [ ] Ensure no console errors in browser when using hierarchy tree

---

## Dev Notes

### Previous Story Insights

**From Story 2.1 (Create Three-Column Layout Component):**
- ✅ WorkspaceShell component established with three resizable panels
- ✅ LeftPanel placeholder component exists at `apps/web/components/workspace/LeftPanel.tsx`
- ✅ LeftPanel currently displays placeholder content and accepts `initiativeId` prop
- ✅ shadcn/ui components (Button, Card, Separator, Tabs, Dialog, Sheet) configured and working
- ✅ Responsive design with collapse/drawer behavior for tablet/mobile
- ✅ localStorage persistence for panel sizes working
- ✅ Testing infrastructure solid (Vitest + React Testing Library)
- ✅ Accessibility standards (WCAG AA) being followed

**Key Integration Points:**
- HierarchyTree will replace the placeholder content in LeftPanel
- LeftPanel is already wired into WorkspaceShell at `apps/web/components/workspace/WorkspaceShell.tsx`
- Current route pattern: `/dashboard/initiatives/[initiativeId]`
- Need to define new Epic detail route: `/dashboard/initiatives/[initiativeId]/epics/[epicId]` (or similar)

**Current State:**
- `apps/web/components/workspace/LeftPanel.tsx` exists with placeholder content
- Need to create new `apps/web/components/hierarchy/` directory for tree components
- No Initiative API endpoints exist yet (will be mocked, real implementation in Epic 7)
- No Epic data structure exists yet (will be mocked, real parsing from PRD in Epic 6/7)

---

### Architecture Context

#### Component Hierarchy
[Source: [architecture/6-components-architecture.md#61-component-hierarchy](../architecture/6-components-architecture.md#61-component-hierarchy)]

**Expected Component Structure (To Be Created):**
```
apps/web/
├── components/
│   ├── workspace/                    # Already exists from Story 2.1
│   │   └── WorkspaceShell.tsx        # UPDATE - Replace react-resizable-panels with SidebarProvider
│   ├── hierarchy/                    # NEW - Sidebar navigation components
│   │   ├── AppSidebar.tsx            # NEW - Main sidebar with hierarchy navigation
│   │   └── __tests__/                # NEW - Tests directory
│   │       └── AppSidebar.test.tsx
│   └── ui/                           # shadcn/ui primitives (already exists)
│       └── sidebar.tsx               # NEW - shadcn Sidebar component (via npx shadcn add)
├── lib/
│   ├── hooks/                        # NEW - React Query hooks
│   │   ├── useInitiatives.ts         # NEW - Fetch initiatives
│   │   ├── useEpics.ts               # NEW - Fetch epics
│   │   └── __tests__/                # NEW - Hook tests
│   └── services/                     # NEW - Data services
│       └── mock-data.ts              # NEW - Mock data until Epic 7 APIs
├── app/
│   └── globals.css                   # UPDATE - Add sidebar CSS variables
```

**This Story Scope:**
- Replace react-resizable-panels with shadcn Sidebar in WorkspaceShell
- Create AppSidebar component with expandable Initiative/Epic nodes using SidebarMenu
- Implement navigation to Initiative overview and Epic detail pages
- Built-in keyboard navigation and accessibility (from shadcn components)
- Use mock data for Initiatives and Epics (real APIs in Epic 7)
- Do NOT build actual Initiative CRUD or Epic parsing (deferred to Epic 6/7)

---

#### Data Models - Initiative & Epic
[Source: [architecture/4-data-models.md#model-3-initiative](../architecture/4-data-models.md#model-3-initiative)]

**Initiative Model:**
```typescript
type InitiativeStatus = 'active' | 'archived';
type InitiativePhase = 'planning' | 'development' | 'testing' | 'deployed';

interface Initiative {
  id: string;                    // UUID
  user_id: string;               // UUID
  title: string;
  description: string | null;
  status: InitiativeStatus;
  phase: InitiativePhase;
  phase_progress: number;        // 0-100
  created_at: string;
  updated_at: string;
  archived_at: string | null;
}
```

**Epic Model (From architecture, Phase 2):**
```typescript
interface Epic {
  id: string;                    // UUID or generated from PRD section
  initiative_id: string;
  document_id: string;           // PRD document ID
  epic_number: number;           // Sequential number (1, 2, 3...)
  title: string;                 // Epic heading from PRD
  description: string | null;    // Epic summary
  story_count: number;           // Number of stories in epic
  status: 'pending' | 'in_progress' | 'completed';
}
```

**For This Story (MVP Simplification):**
- Use mock Initiative data: `getMockInitiatives()` returns 2-3 sample initiatives
- Use mock Epic data: `getMockEpics(initiativeId)` returns 3-5 sample epics per initiative
- Epic data structure can be simplified for mock purposes (just id, title, epic_number)
- Real Initiative CRUD API will be implemented in Epic 7 (Story 7.1-7.3)
- Real Epic parsing from PRD will be implemented in Epic 6 (Story 6.3) or Epic 7

---

#### API Endpoints (For Future Reference)
[Source: [architecture/5-api-specification.md#54-example-api-routes](../architecture/5-api-specification.md#54-example-api-routes)]

**GET /api/initiatives** - List user's initiatives (Future - Epic 7)
```typescript
// Response (200 OK)
{
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Customer Portal MVP",
      "status": "active",
      "phase": "planning",
      "phase_progress": 33,
      ...
    }
  ]
}
```

**GET /api/initiatives/{initiativeId}/epics** - List epics for initiative (Future - Epic 6/7)
```typescript
// Response (200 OK)
{
  "data": [
    {
      "id": "epic-1",
      "epic_number": 1,
      "title": "User Authentication & Authorization",
      "story_count": 8,
      "status": "in_progress"
    }
  ]
}
```

**For This Story:**
- Mock these API responses in `lib/services/mock-data.ts`
- Use React Query hooks to fetch data (will seamlessly switch to real APIs later)
- API implementation deferred to Epic 7

---

#### React Query Data Fetching Pattern
[Source: [architecture/10-frontend-architecture-details.md#103-data-fetching-patterns](../architecture/10-frontend-architecture-details.md#103-data-fetching-patterns)]

**React Query Hook Pattern:**
```typescript
// Example from architecture
export function useInitiative(initiativeId: string) {
  return useQuery({
    queryKey: ['initiative', initiativeId],
    queryFn: () => fetchInitiative(initiativeId),
  });
}
```

**For This Story - useInitiatives Hook:**
```typescript
// apps/web/lib/hooks/useInitiatives.ts
import { useQuery } from '@tanstack/react-query';
import { getMockInitiatives } from '@/lib/services/mock-data';

export function useInitiatives() {
  return useQuery({
    queryKey: ['initiatives'],
    queryFn: getMockInitiatives,
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
}
```

**For This Story - useEpics Hook:**
```typescript
// apps/web/lib/hooks/useEpics.ts
import { useQuery } from '@tanstack/react-query';
import { getMockEpics } from '@/lib/services/mock-data';

export function useEpics(initiativeId: string) {
  return useQuery({
    queryKey: ['epics', initiativeId],
    queryFn: () => getMockEpics(initiativeId),
    enabled: !!initiativeId, // Only fetch if initiativeId exists
    staleTime: 5 * 60 * 1000,
  });
}
```

**React Query Configuration:**
- React Query provider should already be configured in root layout from previous stories
- If not, add QueryClientProvider to `apps/web/app/layout.tsx`
- Use default cache settings (staleTime: 5 minutes, cacheTime: 10 minutes)

---

#### Sidebar Component Choice
[Source: shadcn/ui Sidebar Documentation]

**Chosen Approach:**
- Use **shadcn/ui Sidebar component** (official shadcn pattern for navigation)
- Rationale:
  - Professional, production-ready sidebar with built-in features
  - Composable components (SidebarProvider, Sidebar, SidebarMenu, etc.)
  - Built-in accessibility (ARIA attributes, keyboard navigation)
  - Collapsible functionality with icons
  - Responsive behavior (offcanvas, icon collapse modes)
  - Theming support with CSS variables
  - Matches the design reference provided by user

**Installation:**
```bash
npx shadcn@latest add sidebar
```

**Required CSS Variables (add to apps/web/app/globals.css):**
```css
@layer base {
  :root {
    --sidebar: oklch(0.985 0 0);
    --sidebar-foreground: oklch(0.145 0 0);
    --sidebar-primary: oklch(0.205 0 0);
    --sidebar-primary-foreground: oklch(0.985 0 0);
    --sidebar-accent: oklch(0.97 0 0);
    --sidebar-accent-foreground: oklch(0.205 0 0);
    --sidebar-border: oklch(0.922 0 0);
    --sidebar-ring: oklch(0.708 0 0);
  }

  .dark {
    --sidebar: oklch(0.205 0 0);
    --sidebar-foreground: oklch(0.985 0 0);
    --sidebar-primary: oklch(0.488 0.243 264.376);
    --sidebar-primary-foreground: oklch(0.985 0 0);
    --sidebar-accent: oklch(0.269 0 0);
    --sidebar-accent-foreground: oklch(0.985 0 0);
    --sidebar-border: oklch(1 0 0 / 10%);
    --sidebar-ring: oklch(0.439 0 0);
  }
}
```

**Basic Sidebar Structure:**
```tsx
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupLabel,
  SidebarGroupContent,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarMenuSub,
  SidebarMenuSubItem,
  SidebarMenuSubButton,
} from '@/components/ui/sidebar';
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from '@/components/ui/collapsible';

<Sidebar>
  <SidebarContent>
    <SidebarGroup>
      <SidebarGroupLabel>Projects</SidebarGroupLabel>
      <SidebarGroupContent>
        <SidebarMenu>
          {/* Initiative with collapsible Epics */}
          <Collapsible className="group/collapsible">
            <SidebarMenuItem>
              <CollapsibleTrigger asChild>
                <SidebarMenuButton>
                  <ChevronRight className="transition-transform group-data-[state=open]/collapsible:rotate-90" />
                  Initiative Title
                </SidebarMenuButton>
              </CollapsibleTrigger>
              <CollapsibleContent>
                <SidebarMenuSub>
                  <SidebarMenuSubItem>
                    <SidebarMenuSubButton asChild>
                      <Link href="/dashboard/initiatives/id/epics/epic-1">
                        Epic 1
                      </Link>
                    </SidebarMenuSubButton>
                  </SidebarMenuSubItem>
                </SidebarMenuSub>
              </CollapsibleContent>
            </SidebarMenuItem>
          </Collapsible>
        </SidebarMenu>
      </SidebarGroupContent>
    </SidebarGroup>
  </SidebarContent>
</Sidebar>
```

---

#### Navigation Routes
[Source: [architecture/10-frontend-architecture-details.md#101-nextjs-app-router-structure](../architecture/10-frontend-architecture-details.md#101-nextjs-app-router-structure)]

**Existing Route (From Story 2.1):**
- `/dashboard/initiatives/[initiativeId]` - Three-column workspace

**New Routes Needed for This Story:**
- **Initiative Overview Route:** `/dashboard/initiatives/[initiativeId]` (already exists, clicking Initiative navigates here)
- **Epic Detail Route:** `/dashboard/initiatives/[initiativeId]/epics/[epicId]` (NEW, need to create)

**Epic Detail Route Structure:**
```
apps/web/app/
└── dashboard/
    └── initiatives/
        └── [initiativeId]/
            ├── page.tsx           # Workspace (already exists)
            └── epics/
                └── [epicId]/
                    └── page.tsx   # NEW - Epic detail page
```

**Epic Detail Page Implementation (Simplified for MVP):**
```tsx
// apps/web/app/dashboard/initiatives/[initiativeId]/epics/[epicId]/page.tsx
'use client';

import { useParams } from 'next/navigation';
import WorkspaceShell from '@/components/workspace/WorkspaceShell';

export default function EpicDetailPage() {
  const params = useParams();
  const initiativeId = params.initiativeId as string;
  const epicId = params.epicId as string;

  // For MVP, same workspace layout but with epic context
  // MiddlePanel can display epic-specific documents
  return <WorkspaceShell initiativeId={initiativeId} epicId={epicId} />;
}
```

**Navigation Implementation:**
```tsx
// In HierarchyTree.tsx
import { useRouter } from 'next/navigation';

const router = useRouter();

// Navigate to Initiative overview
const handleInitiativeClick = (initiativeId: string) => {
  router.push(`/dashboard/initiatives/${initiativeId}`);
};

// Navigate to Epic detail
const handleEpicClick = (initiativeId: string, epicId: string) => {
  router.push(`/dashboard/initiatives/${initiativeId}/epics/${epicId}`);
};
```

---

#### WorkspaceShell Integration with Sidebar
[Source: shadcn/ui Sidebar Documentation + Story 2.1 WorkspaceShell]

**Current WorkspaceShell Structure (Story 2.1):**
- Uses `react-resizable-panels` with three panels (Left, Middle, Right)
- Left panel contains LeftPanel component (placeholder)
- Middle and Right panels use Panel components

**New Structure (This Story):**
- Replace with `SidebarProvider` wrapper
- Use `Sidebar` component for left navigation (replaces react-resizable-panels left Panel)
- Use `SidebarInset` for main content area (middle and right panels)
- Maintain responsive behavior from Story 2.1

**Updated WorkspaceShell Pattern:**
```tsx
'use client';

import { SidebarProvider, SidebarInset, SidebarTrigger } from '@/components/ui/sidebar';
import { AppSidebar } from '@/components/hierarchy/AppSidebar';
import MiddlePanel from './MiddlePanel';
import RightPanel from './RightPanel';

export default function WorkspaceShell({ initiativeId }: { initiativeId: string }) {
  return (
    <SidebarProvider>
      {/* Left: Sidebar with navigation */}
      <AppSidebar />

      {/* Middle and Right: Main content area */}
      <SidebarInset>
        {/* Header with trigger button */}
        <header className="flex h-16 items-center gap-2 px-4">
          <SidebarTrigger />
        </header>

        {/* Content area with Middle and Right panels */}
        <div className="flex flex-1 gap-4 p-4">
          <MiddlePanel initiativeId={initiativeId} />
          <RightPanel initiativeId={initiativeId} />
        </div>
      </SidebarInset>
    </SidebarProvider>
  );
}
```

**Breaking Changes from Story 2.1:**
- ⚠️ **react-resizable-panels** will be **removed** from WorkspaceShell
- ⚠️ **LeftPanel.tsx** will be **removed** (replaced by AppSidebar)
- ⚠️ **localStorage persistence** for panel sizes will be **replaced** by Sidebar's built-in persistence
- ✅ Middle and Right panels remain unchanged
- ✅ Responsive behavior maintained (Sidebar has built-in mobile support)

**Migration Notes:**
- Update WorkspaceShell tests to use SidebarProvider instead of PanelGroup
- Remove LeftPanel component tests (replaced by AppSidebar tests)
- Verify middle and right panels still render correctly in SidebarInset
- Test sidebar collapse/expand functionality
- Verify keyboard navigation (SidebarTrigger with Cmd+B / Ctrl+B)

---

#### Keyboard Navigation Implementation
[Source: shadcn/ui Sidebar Documentation + WCAG AA Standards]

**Built-in Keyboard Support (from shadcn Sidebar):**
- **Tab:** Navigate through menu items sequentially
- **Shift+Tab:** Navigate backwards through menu items
- **Enter/Space:** Activate focused menu item (navigate or expand/collapse)
- **Cmd+B (Mac) / Ctrl+B (Windows):** Toggle sidebar visibility (built-in shortcut)
- **Arrow keys:** Navigate through Collapsible triggers

**Keyboard Navigation Features:**
- ✅ `SidebarMenuButton` components are natively keyboard accessible
- ✅ `Collapsible` component includes aria-expanded and keyboard support
- ✅ Focus indicators are built into shadcn components
- ✅ Screen reader announcements for expand/collapse states
- ✅ Tab order follows visual hierarchy (Initiatives → Epics)

**No Custom Implementation Needed:**
- shadcn Sidebar components handle keyboard navigation automatically
- CollapsibleTrigger responds to Enter/Space for expand/collapse
- SidebarMenuButton with Next.js Link supports keyboard activation
- Focus management is built into Radix UI primitives (underlying shadcn components)

**Testing Focus:**
- Verify Tab key moves through menu items in correct order
- Verify Enter/Space activates links and Collapsible triggers
- Verify Cmd+B / Ctrl+B toggles sidebar
- Verify focus indicators are visible (ring styles)
- Test with keyboard-only navigation (no mouse)

---

#### Active Node Highlighting
[Source: AC 4]

**Determine Active Node from Pathname:**
```tsx
import { usePathname } from 'next/navigation';

const pathname = usePathname(); // e.g., "/dashboard/initiatives/abc-123" or "/dashboard/initiatives/abc-123/epics/epic-2"

// Parse initiativeId from pathname
const activeInitiativeId = pathname.match(/\/initiatives\/([^\/]+)/)?.[1];

// Parse epicId from pathname (if present)
const activeEpicId = pathname.match(/\/epics\/([^\/]+)/)?.[1];

// Apply active styles
const isActive = node.id === activeInitiativeId || node.id === activeEpicId;
const className = isActive ? 'bg-accent text-accent-foreground' : 'hover:bg-accent/50';
```

**Auto-Expand Active Node:**
- If active node is an Epic, ensure its parent Initiative is expanded
- Implement in useEffect on component mount or pathname change

---

#### Styling Standards
[Source: [architecture/15-coding-standards.md](../architecture/15-coding-standards.md)]

**Tree Node Styling:**
- Use Tailwind utility classes for spacing, colors, hover states
- Initiative nodes: `px-3 py-2 rounded-md cursor-pointer`
- Epic nodes: `pl-8 pr-3 py-1.5 rounded-md cursor-pointer` (increased left padding)
- Active node: `bg-accent text-accent-foreground`
- Hover state: `hover:bg-accent/50`
- Icons: lucide-react ChevronRight (collapsed), ChevronDown (expanded)
- Font sizes: Initiative (text-sm font-medium), Epic (text-sm)

**Scrolling:**
- LeftPanel should have `overflow-y-auto` to allow scrolling
- HierarchyTree should fill available height

---

### Testing

#### Testing Standards
[Source: [architecture/14-testing-strategy.md](../architecture/14-testing-strategy.md)]

**Testing Framework:** Vitest + React Testing Library

**Unit Testing Requirements:**
- Target: >80% coverage for HierarchyTree component
- Test component rendering with mocked data
- Test expand/collapse interactions
- Test navigation clicks (mock useRouter)
- Test keyboard navigation events
- Test active node highlighting (mock usePathname)
- Mock React Query hooks with MSW or vi.mock

**Test File Locations:**
- `apps/web/components/hierarchy/__tests__/HierarchyTree.test.tsx` (NEW)
- `apps/web/lib/hooks/__tests__/useInitiatives.test.ts` (NEW)
- `apps/web/lib/hooks/__tests__/useEpics.test.ts` (NEW)
- `apps/web/components/workspace/__tests__/LeftPanel.integration.test.tsx` (NEW)

**Example Test Structure for HierarchyTree:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import HierarchyTree from '../HierarchyTree';

// Mock Next.js hooks
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
  }),
  usePathname: () => '/dashboard/initiatives/test-id',
}));

// Mock React Query hooks
vi.mock('@/lib/hooks/useInitiatives', () => ({
  useInitiatives: () => ({
    data: [
      { id: 'init-1', title: 'Initiative 1', status: 'active' },
      { id: 'init-2', title: 'Initiative 2', status: 'active' },
    ],
    isLoading: false,
    isError: false,
  }),
}));

vi.mock('@/lib/hooks/useEpics', () => ({
  useEpics: (initiativeId: string) => ({
    data: [
      { id: 'epic-1', epic_number: 1, title: 'Epic 1' },
      { id: 'epic-2', epic_number: 2, title: 'Epic 2' },
    ],
    isLoading: false,
    isError: false,
  }),
}));

describe('HierarchyTree', () => {
  const queryClient = new QueryClient();

  beforeEach(() => {
    queryClient.clear();
  });

  it('renders initiative nodes', () => {
    render(
      <QueryClientProvider client={queryClient}>
        <HierarchyTree />
      </QueryClientProvider>
    );
    expect(screen.getByText('Initiative 1')).toBeInTheDocument();
    expect(screen.getByText('Initiative 2')).toBeInTheDocument();
  });

  it('expands initiative to show epics when clicked', async () => {
    render(
      <QueryClientProvider client={queryClient}>
        <HierarchyTree />
      </QueryClientProvider>
    );

    // Click expand icon for Initiative 1
    const expandButton = screen.getAllByRole('button')[0];
    fireEvent.click(expandButton);

    // Epic nodes should appear
    expect(await screen.findByText('Epic 1')).toBeInTheDocument();
    expect(await screen.findByText('Epic 2')).toBeInTheDocument();
  });

  it('highlights active node based on pathname', () => {
    render(
      <QueryClientProvider client={queryClient}>
        <HierarchyTree />
      </QueryClientProvider>
    );

    // Initiative with id 'test-id' should be highlighted (matches pathname mock)
    // Check for active class on the node
    const activeNode = screen.getByText('Initiative 1').closest('div');
    expect(activeNode).toHaveClass('bg-accent');
  });

  it('navigates to initiative on Enter key press', () => {
    const { push } = vi.mocked(useRouter)();
    render(
      <QueryClientProvider client={queryClient}>
        <HierarchyTree />
      </QueryClientProvider>
    );

    const initiativeNode = screen.getByText('Initiative 1');
    fireEvent.keyDown(initiativeNode, { key: 'Enter' });

    expect(push).toHaveBeenCalledWith('/dashboard/initiatives/init-1');
  });
});
```

**Coverage Targets:**
- Unit tests: >80% coverage for HierarchyTree and hooks
- Integration tests: LeftPanel with HierarchyTree rendering
- Accessibility: Keyboard navigation and ARIA attributes verified in tests

**Test Execution:**
- Run unit tests: `pnpm --filter @outcome-signal/web test -- --run`
- Check coverage: `pnpm --filter @outcome-signal/web test -- --coverage`

---

#### Accessibility Testing
[Source: WCAG AA Standards + AC 5]

**Accessibility Requirements (WCAG AA):**

**ARIA Attributes:**
- Tree container: `role="tree"` with `aria-label="Initiative hierarchy"`
- Initiative nodes: `role="treeitem"` with `aria-expanded` (true/false)
- Epic nodes: `role="treeitem"` with `aria-level="2"`
- Active node: `aria-selected="true"`
- Expand/collapse icons: `aria-hidden="true"` (decorative)

**Keyboard Navigation (Already Covered in AC 5):**
- Arrow keys for navigation (Up, Down, Left, Right)
- Enter/Space to activate node
- Tab to exit tree

**Screen Reader Testing:**
- Use VoiceOver (macOS: Cmd+F5) or NVDA (Windows)
- Verify tree structure is announced correctly
- Verify node names and expanded/collapsed states are announced
- Verify active node is announced as "selected"

**Manual Testing Checklist:**
- [ ] Navigate tree with keyboard only (no mouse)
- [ ] Activate nodes with Enter/Space keys
- [ ] Verify focus indicators are visible on all nodes
- [ ] Test with screen reader for proper announcements
- [ ] Verify tree structure is logical and navigable

---

#### Client Component Requirements
[Source: [architecture/10-frontend-architecture-details.md#102-react-server-components-vs-client-components](../architecture/10-frontend-architecture-details.md#102-react-server-components-vs-client-components)]

**Client Components (`'use client'`):**
- HierarchyTree must be a client component (uses hooks: useState, useRouter, usePathname, useQuery)
- LeftPanel must remain a client component (already is from Story 2.1)

**Client Component Pattern:**
```tsx
'use client';

import { useState } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useInitiatives } from '@/lib/hooks/useInitiatives';
import { useEpics } from '@/lib/hooks/useEpics';

export default function HierarchyTree() {
  const router = useRouter();
  const pathname = usePathname();
  const { data: initiatives, isLoading, isError } = useInitiatives();
  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());

  // Component implementation
}
```

---

#### TypeScript Standards
[Source: [architecture/15-coding-standards.md#151-typescript-standards](../architecture/15-coding-standards.md#151-typescript-standards)]

**TypeScript Interfaces for This Story:**

```typescript
// Initiative interface (from architecture/4-data-models.md)
type InitiativeStatus = 'active' | 'archived';
type InitiativePhase = 'planning' | 'development' | 'testing' | 'deployed';

interface Initiative {
  id: string;
  user_id: string;
  title: string;
  description: string | null;
  status: InitiativeStatus;
  phase: InitiativePhase;
  phase_progress: number;
  created_at: string;
  updated_at: string;
  archived_at: string | null;
}

// Epic interface (simplified for MVP mock data)
interface Epic {
  id: string;
  initiative_id: string;
  epic_number: number;
  title: string;
  story_count?: number;
  status?: 'pending' | 'in_progress' | 'completed';
}

// Tree node props
interface TreeNodeProps {
  initiative: Initiative;
  epics: Epic[];
  isExpanded: boolean;
  isActive: boolean;
  onExpand: () => void;
  onNavigate: (id: string) => void;
}
```

**Type Safety Rules:**
- Use explicit return types on all functions
- No `any` type - use `unknown` with type guards
- Proper interface definitions for all props
- Use strict mode (already enabled in tsconfig.json)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story draft created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
- (To be filled by Dev Agent)

### Debug Log References
- (To be filled by Dev Agent)

### Completion Notes List
- (To be filled by Dev Agent)

### File List
- (To be filled by Dev Agent)

---

## QA Results

- (To be filled by QA Agent)

---
